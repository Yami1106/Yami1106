name: Gear Animation Based on Total Commits

on:
  schedule:
    - cron: "0 * * * *" # Runs every hour to update the gear animation

jobs:
  update-gear:
    runs-on: ubuntu-latest
    steps:
      # 1. Fetch all public repositories
      - name: Get all repositories
        id: repos
        run: |
          repos=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/users/Yami1106/repos?per_page=100" | jq -r '.[].name')
          echo "repos=$repos" >> $GITHUB_ENV

      # 2. Fetch commit counts for each repository
      - name: Calculate total commits
        id: commits
        run: |
          total_commits=0
          for repo in ${{ env.repos }}; do
            commits=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/Yami1106/$repo/stats/contributors" | jq '[.[].total | select(. != null)] | add')
            if [ -n "$commits" ]; then
              total_commits=$((total_commits + commits))
            fi
          done
          echo "Total commits: $total_commits"
          echo "total_commits=$total_commits" >> $GITHUB_ENV

      # 3. Update the gear SVG animation speed
      - name: Update SVG Animation Speed
        run: |
          speed=$(echo "scale=2; 5/(${{ env.total_commits }} + 1)" | bc -l) # Adjust speed based on commits
          sed -i "s/dur=\"[0-9.]*s\"/dur=\"${speed}s\"/" assets/spinning-gear.svg

      # 4. Commit and push the updated SVG
      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/spinning-gear.svg
          git commit -m "Updated gear animation based on total commits"
          git push